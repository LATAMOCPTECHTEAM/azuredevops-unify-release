{
    "id": "d953abf4-2d1f-4ba7-bee9-2a43df803f2b",
    "name": "unify-release-task",
    "friendlyName": "Unify Release",
    "description": "Auxiliary Task to unify multiple builds from the same source code to a single release",
    "helpMarkDown": "",
    "category": "Utility",
    "author": "Paulo Baima",
    "version": {
        "Major": 0,
        "Minor": 1,
        "Patch": 1
    },
    "instanceNameFormat": "Unify Release",
    "inputs": [
        {
            "name": "releaseTag",
            "type": "string",
            "label": "Release Ready Tag",
            "defaultValue": "create_release",
            "required": true,
            "helpMarkDown": "The tag that will be created on the build if this is the last completed build from the same checkin. You must add this tag as a required Build Tag on the Artifact Trigger of the Release Pipeline"
        },
        {
            "name": "releaseOnError",
            "type": "boolean",
            "label": "Release on Error",
            "defaultValue": false,
            "required": true,
            "helpMarkDown": "Specify if the Build Tag should be create even if one of the related builds fails"
        },
        {
            "name": "releaseOnCancel",
            "type": "boolean",
            "label": "Release on Cancel",
            "defaultValue": false,
            "required": true,
            "helpMarkDown": "Specify if the Build Tag should be create even if one of the related builds was cancelled"
        },
        {
            "name": "waitForAllBuilds",
            "type": "boolean",
            "label": "Wait for All Triggered Builds",
            "defaultValue": true,
            "required": true,
            "helpMarkDown": "If true, this build will depend on all builds that were triggered from the same Source Version to be finished"
        },
        {
            "name": "project",
            "type": "pickList",
            "label": "Project",
            "defaultValue": "",
            "required": false,
            "properties": {
                "EditableOptions": "True",
                "DisableManageLink": "True"
            },
            "helpMarkDown": "Select the project were this build has definitions it will depend on",
            "visibleRule": "waitForAllBuilds == false"
        },
        {
            "name": "definition1",
            "type": "pickList",
            "label": "Build pipeline",
            "defaultValue": "",
            "required": false,
            "properties": {
                "EditableOptions": "True",
                "DisableManageLink": "True",
                "IsSearchable": "True"
            },
            "helpMarkDown": "Select the builds that this build will depend on. (if triggered from the same Source Version)",
            "visibleRule": "project != \"\""
        }
    ],
    "dataSourceBindings": [
        {
            "endpointId": "tfs:teamfoundation",
            "target": "project",
            "endpointUrl": "{{endpoint.url}}/_apis/projects?$skip={{skip}}&$top=1000",
            "resultSelector": "jsonpath:$.value[?(@.state=='wellFormed')]",
            "resultTemplate": "{ \"Value\" : \"{{{id}}}\", \"DisplayValue\" : \"{{{name}}}\" }",
            "callbackContextTemplate": "{\"skip\": \"{{add skip 1000}}\"}",
            "callbackRequiredTemplate": "{{isEqualNumber result.count 1000}}",
            "initialContextTemplate": "{\"skip\": \"0\"}"
        },
        {
            "endpointId": "tfs:teamfoundation",
            "target": "definition1",
            "endpointUrl": "{{endpoint.url}}/{{project}}/_apis/build/definitions?api-version=3.0-preview&$top=500&continuationToken={{{continuationToken}}}&queryOrder=2",
            "resultSelector": "jsonpath:$.value[?(@.quality=='definition')]",
            "parameters": {
                "project": "$(project)"
            },
            "resultTemplate": "{ \"Value\" : \"{{{id}}}\", \"DisplayValue\" : \"{{{name}}}\" }",
            "callbackContextTemplate": "{\"continuationToken\" : \"{{{headers.x-ms-continuationtoken}}}\"}",
            "callbackRequiredTemplate": "{{{#headers.x-ms-continuationtoken}}}true{{{/headers.x-ms-continuationtoken}}}",
            "initialContextTemplate": "{\"continuationToken\" : \"{{{system.utcNow}}}\"}"
        }
    ],
    "execution": {
        "Node10": {
            "target": "bin/index.js"
        }
    }
}